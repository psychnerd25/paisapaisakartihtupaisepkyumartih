<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Unified Income → Budget → Financial Independence Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-slate-100 font-sans p-6">
    <div class="max-w-6xl mx-auto space-y-6">
      <!-- Header -->
      <div class="bg-white rounded-2xl shadow p-6">
        <h1 class="text-2xl font-semibold text-slate-800">
          Income · Budget · Financial Independence
        </h1>
        <p class="text-sm text-slate-500 mt-1">
          Enter income, adjust budget split (Needs/Wants/Savings/Good Deeds).
          Savings feeds the retirement planner automatically.
        </p>
      </div>

      <!-- Top: Income + Budget -->
      <div class="bg-white rounded-2xl shadow p-6 grid md:grid-cols-2 gap-6">
        <div>
          <h2 class="font-semibold text-slate-700 mb-2">Income & Tax</h2>
          <label class="block text-sm text-slate-600">Annual Income (₹)</label>
          <input
            id="income"
            type="text"
            value=""
            placeholder="e.g. 12,00,000"
            class="mt-1 w-full border rounded px-3 py-2 focus:ring-2 focus:ring-teal-500"
          />

          <div
            id="taxCard"
            class="mt-4 bg-slate-50 rounded p-3 text-sm space-y-2"
          >
            <div class="flex justify-between">
              <span class="text-slate-600">Taxable income</span
              ><span id="taxable">—</span>
            </div>
            <div class="flex justify-between">
              <span class="text-slate-600">Total tax</span
              ><span id="total">—</span>
            </div>
            <div class="flex justify-between">
              <span class="text-slate-600">Effective tax rate</span
              ><span id="rate">—</span>
            </div>
            <div class="flex justify-between">
              <span class="font-semibold text-slate-700">Monthly take-home</span
              ><span id="takehome" class="font-semibold text-teal-600">—</span>
            </div>
          </div>
        </div>

        <div>
          <h2 class="font-semibold text-slate-700 mb-2">
            Monthly Budget Split (%)
          </h2>

          <div class="grid grid-cols-4 gap-2">
            <div>
              <label class="text-xs text-slate-500">Needs</label>
              <input
                id="needs"
                type="number"
                min="0"
                max="100"
                value="50"
                class="w-full border rounded px-2 py-1 text-center"
              />
            </div>
            <div>
              <label class="text-xs text-slate-500">Wants</label>
              <input
                id="wants"
                type="number"
                min="0"
                max="100"
                value="30"
                class="w-full border rounded px-2 py-1 text-center"
              />
            </div>
            <div>
              <label class="text-xs text-slate-500">Savings</label>
              <input
                id="savingsPct"
                type="number"
                min="0"
                max="100"
                value="20"
                class="w-full border rounded px-2 py-1 text-center"
              />
            </div>
            <div>
              <label class="text-xs text-slate-500">Good Deeds</label>
              <input
                id="good"
                type="number"
                min="0"
                max="100"
                value="0"
                class="w-full border rounded px-2 py-1 text-center"
              />
            </div>
          </div>

          <div
            id="ratioError"
            class="hidden mt-2 text-sm text-red-600 font-medium"
          ></div>

          <div
            id="budgetOutput"
            class="mt-4 bg-slate-50 rounded p-3 text-sm space-y-2"
          >
            <div class="flex justify-between">
              <span class="text-slate-600">Needs (₹ / month)</span
              ><span id="needsAmt">—</span>
            </div>
            <div class="flex justify-between">
              <span class="text-slate-600">Wants (₹ / month)</span
              ><span id="wantsAmt">—</span>
            </div>
            <div class="flex justify-between">
              <span class="text-slate-600">Savings (₹ / month)</span
              ><span id="savingsAmt">—</span>
            </div>
            <div class="flex justify-between">
              <span class="text-slate-600">Good Deeds (₹ / month)</span
              ><span id="goodAmt">—</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Bottom: Financial Independence Planner -->
      <div class="bg-white rounded-2xl shadow p-6 space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold text-slate-700">
            Financial Independence Planner (auto)
          </h2>
          <div class="text-sm text-slate-500">
            Savings used as monthly investment
          </div>
        </div>

        <!-- planner inputs -->
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm text-slate-600 mb-1">Current Age</label>
            <input
              id="currentAge"
              type="number"
              value="22"
              class="w-full border rounded px-3 py-2 text-center"
            />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1"
              >Retirement Age</label
            >
            <input
              id="retireAge"
              type="number"
              value="50"
              class="w-full border rounded px-3 py-2 text-center"
            />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1"
              >Expenses planned until age</label
            >
            <input
              id="deathAge"
              type="number"
              value="85"
              class="w-full border rounded px-3 py-2 text-center"
            />
          </div>
        </div>

        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm text-slate-600 mb-1"
              >Current Savings (₹)</label
            >
            <!-- changed to text so commas allowed -->
            <input
              id="currentSavings"
              type="text"
              value="0"
              class="w-full border rounded px-3 py-2 text-center"
            />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1"
              >Step-up in Savings (% / yr)</label
            >
            <input
              id="stepUp"
              type="number"
              value="5"
              class="w-full border rounded px-3 py-2 text-center"
            />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1"
              >Post-retirement Monthly Expenses (Today's ₹)</label
            >
            <!-- changed to text so commas allowed -->
            <input
              id="retireExpenses"
              type="text"
              value="50000"
              class="w-full border rounded px-3 py-2 text-center"
            />
          </div>
        </div>

        <div class="grid md:grid-cols-1 gap-4">
          <div>
            <label class="block text-sm text-slate-600 mb-1"
              >Inflation (%)</label
            >
            <input
              id="inflation"
              type="number"
              value="5"
              class="w-full border rounded px-3 py-2 text-center"
            />
          </div>
        </div>

        <!-- Investment approach tables -->
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <h3 class="font-medium text-slate-700 mb-2">
              Current Savings - Investment Approach
            </h3>
            <table class="min-w-full text-sm border">
              <thead class="bg-slate-200">
                <tr>
                  <th class="p-2 border">Instrument</th>
                  <th class="p-2 border">Returns</th>
                  <th class="p-2 border">Tax</th>
                  <th class="p-2 border">Share</th>
                </tr>
              </thead>
              <tbody>
                <tr class="border-b">
                  <td class="p-2">Fixed Returns</td>
                  <td class="p-2">
                    <input
                      id="preFixR"
                      value="7"
                      class="w-full text-center border rounded"
                    />
                  </td>
                  <td class="p-2">
                    <input
                      id="preFixT"
                      value="30"
                      class="w-full text-center border rounded"
                    />
                  </td>
                  <td class="p-2">
                    <input
                      id="preFixS"
                      value="20"
                      class="w-full text-center border rounded"
                    />
                  </td>
                </tr>
                <tr class="border-b">
                  <td class="p-2">Large Cap Mutual Funds</td>
                  <td class="p-2">
                    <input
                      id="preLCapR"
                      value="12"
                      class="w-full text-center border rounded"
                    />
                  </td>
                  <td class="p-2">
                    <input
                      id="preLCapT"
                      value="20"
                      class="w-full text-center border rounded"
                    />
                  </td>
                  <td class="p-2">
                    <input
                      id="preLCapS"
                      value="40"
                      class="w-full text-center border rounded"
                    />
                  </td>
                </tr>
                <tr class="border-b">
                  <td class="p-2">Midcap Mutual Funds</td>
                  <td class="p-2">
                    <input
                      id="preMCapR"
                      value="15"
                      class="w-full text-center border rounded"
                    />
                  </td>
                  <td class="p-2">
                    <input
                      id="preMCapT"
                      value="20"
                      class="w-full text-center border rounded"
                    />
                  </td>
                  <td class="p-2">
                    <input
                      id="preMCapS"
                      value="30"
                      class="w-full text-center border rounded"
                    />
                  </td>
                </tr>
                <tr>
                  <td class="p-2">Smallcap mutual funds</td>
                  <td class="p-2">
                    <input
                      id="preSCapR"
                      value="18"
                      class="w-full text-center border rounded"
                    />
                  </td>
                  <td class="p-2">
                    <input
                      id="preSCapT"
                      value="20"
                      class="w-full text-center border rounded"
                    />
                  </td>
                  <td class="p-2">
                    <input
                      id="preSCapS"
                      value="10"
                      class="w-full text-center border rounded"
                    />
                  </td>
                </tr>
              </tbody>
              <tfoot class="bg-slate-50 font-semibold">
                <tr>
                  <td class="p-2 text-right">Total:</td>
                  <td class="p-2 text-center" id="preGross">—</td>
                  <td class="p-2 text-center" id="preAfter">—</td>
                  <td class="p-2 text-center" id="preShare">—</td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div>
            <h3 class="font-medium text-slate-700 mb-2">
              Retirement Savings - Investment Approach
            </h3>
            <table class="min-w-full text-sm border">
              <thead class="bg-slate-200">
                <tr>
                  <th class="p-2 border">Instrument</th>
                  <th class="p-2 border">Returns</th>
                  <th class="p-2 border">Tax</th>
                  <th class="p-2 border">Share</th>
                </tr>
              </thead>
              <tbody>
                <tr class="border-b">
                  <td class="p-2">Fixed Returns</td>
                  <td class="p-2">
                    <input
                      id="postFixR"
                      value="7"
                      class="w-full text-center border rounded"
                    />
                  </td>
                  <td class="p-2">
                    <input
                      id="postFixT"
                      value="30"
                      class="w-full text-center border rounded"
                    />
                  </td>
                  <td class="p-2">
                    <input
                      id="postFixS"
                      value="0"
                      class="w-full text-center border rounded"
                    />
                  </td>
                </tr>
                <tr class="border-b">
                  <td class="p-2">Large Cap Mutual Funds</td>
                  <td class="p-2">
                    <input
                      id="postLCapR"
                      value="12"
                      class="w-full text-center border rounded"
                    />
                  </td>
                  <td class="p-2">
                    <input
                      id="postLCapT"
                      value="20"
                      class="w-full text-center border rounded"
                    />
                  </td>
                  <td class="p-2">
                    <input
                      id="postLCapS"
                      value="100"
                      class="w-full text-center border rounded"
                    />
                  </td>
                </tr>
                <tr class="border-b">
                  <td class="p-2">Midcap Mutual Funds</td>
                  <td class="p-2">
                    <input
                      id="postMCapR"
                      value="15"
                      class="w-full text-center border rounded"
                    />
                  </td>
                  <td class="p-2">
                    <input
                      id="postMCapT"
                      value="20"
                      class="w-full text-center border rounded"
                    />
                  </td>
                  <td class="p-2">
                    <input
                      id="postMCapS"
                      value="0"
                      class="w-full text-center border rounded"
                    />
                  </td>
                </tr>
                <tr>
                  <td class="p-2">Smallcap mutual funds</td>
                  <td class="p-2">
                    <input
                      id="postSCapR"
                      value="18"
                      class="w-full text-center border rounded"
                    />
                  </td>
                  <td class="p-2">
                    <input
                      id="postSCapT"
                      value="20"
                      class="w-full text-center border rounded"
                    />
                  </td>
                  <td class="p-2">
                    <input
                      id="postSCapS"
                      value="0"
                      class="w-full text-center border rounded"
                    />
                  </td>
                </tr>
              </tbody>
              <tfoot class="bg-slate-50 font-semibold">
                <tr>
                  <td class="p-2 text-right">Total:</td>
                  <td class="p-2 text-center" id="postGross">—</td>
                  <td class="p2 text-center" id="postAfter">—</td>
                  <td class="p-2 text-center" id="postShare">—</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- Simulation table -->
        <div id="tableArea" class="overflow-x-auto mt-4">
          <table class="min-w-full border text-sm text-slate-700">
            <thead class="bg-slate-200">
              <tr>
                <th class="p-2 border">Age</th>
                <th class="p-2 border">Starting Saving (₹)</th>
                <th class="p-2 border">Planned expenses (post-tax) (₹)</th>
                <th class="p-2 border">Additional Savings (₹)</th>
                <th class="p-2 border">Ending Savings (₹)</th>
                <th class="p-2 border">Status</th>
              </tr>
            </thead>
            <tbody id="resultTable" class="divide-y divide-slate-100"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      /* Utilities */
      const fmt = (n) => "₹" + Math.round(n || 0).toLocaleString("en-IN");

      /* Tax logic */
      const DEFAULT_INCOME = 1200000;
      const STANDARD_DEDUCTION = 75000;
      function parseIncome(str) {
        if (!str) return DEFAULT_INCOME;
        const cleaned = String(str).replace(/[^0-9]/g, "");
        const n = Number(cleaned);
        return Number.isFinite(n) && n >= 0 ? n : DEFAULT_INCOME;
      }
      function formatIndian(num) {
        return num.toLocaleString("en-IN");
      }
      function payable_tax(taxable) {
        if (taxable <= 1200000) return 0;
        if (taxable <= 1600000) return (taxable - 1200000) * 0.15 + 60000;
        if (taxable <= 2000000) return (taxable - 1600000) * 0.2 + 120000;
        if (taxable <= 2400000) return (taxable - 2000000) * 0.25 + 200000;
        return (taxable - 2400000) * 0.3 + 300000;
      }
      function surcharge(income, base_tax) {
        if (income <= 5000000) return 0;
        if (income <= 10000000) return base_tax * 0.1;
        if (income <= 20000000) return base_tax * 0.15;
        if (income <= 50000000) return base_tax * 0.25;
        return base_tax * 0.25;
      }
      function compute_tax(income) {
        const taxable = Math.max(0, income - STANDARD_DEDUCTION);
        const base = payable_tax(taxable);
        const sur = surcharge(income, base);
        const cess = (base + sur) * 0.04;
        const total = Math.round(base + sur + cess);
        const net = income - total;
        const monthlyTakeHome = net / 12;
        return {
          income: Math.round(income),
          taxable: Math.round(taxable),
          total,
          takehome: monthlyTakeHome,
          effective_rate: income > 0 ? (total / income) * 100 : 0,
        };
      }

      /* weighted returns and weighted tax (shares in normal percent scale) */
      function computeWeighted(prefix) {
        const fields = [
          [`${prefix}FixR`, `${prefix}FixT`, `${prefix}FixS`],
          [`${prefix}LCapR`, `${prefix}LCapT`, `${prefix}LCapS`],
          [`${prefix}MCapR`, `${prefix}MCapT`, `${prefix}MCapS`],
          [`${prefix}SCapR`, `${prefix}SCapT`, `${prefix}SCapS`],
        ];
        let totalShare = 0,
          grossSum = 0,
          taxSum = 0;
        for (const [r, t, s] of fields) {
          const rate = Number(document.getElementById(r).value) || 0; // e.g. 7, 12
          const tax = Number(document.getElementById(t).value) || 0; // e.g. 20, 30
          const share = Number(document.getElementById(s).value) || 0; // e.g. 40
          totalShare += share;
          grossSum += share * rate;
          taxSum += share * tax;
        }
        const gross = totalShare ? grossSum / totalShare : 0; // pre-tax composite return (%)
        const tax = totalShare ? taxSum / totalShare : 0; // weighted avg tax (%)
        return { totalShare, gross, tax };
      }

      /* DOM refs */
      const incomeEl = document.getElementById("income");
      const outTaxable = document.getElementById("taxable");
      const outTotal = document.getElementById("total");
      const outRate = document.getElementById("rate");
      const outTakehome = document.getElementById("takehome");

      const needsEl = document.getElementById("needs");
      const wantsEl = document.getElementById("wants");
      const savingsPctEl = document.getElementById("savingsPct");
      const goodEl = document.getElementById("good");
      const ratioError = document.getElementById("ratioError");

      const needsAmtEl = document.getElementById("needsAmt");
      const wantsAmtEl = document.getElementById("wantsAmt");
      const savingsAmtEl = document.getElementById("savingsAmt");
      const goodAmtEl = document.getElementById("goodAmt");

      /* planner inputs */
      const currentAgeEl = document.getElementById("currentAge");
      const retireAgeEl = document.getElementById("retireAge");
      const deathAgeEl = document.getElementById("deathAge");
      const currentSavingsEl = document.getElementById("currentSavings");
      const stepUpEl = document.getElementById("stepUp");
      const retireExpensesEl = document.getElementById("retireExpenses");
      const inflationEl = document.getElementById("inflation");
      /* investment table summary outputs */
      const preGrossEl = document.getElementById("preGross");
      const preAfterEl = document.getElementById("preAfter");
      const preShareEl = document.getElementById("preShare");
      const postGrossEl = document.getElementById("postGross");
      const postAfterEl = document.getElementById("postAfter");
      const postShareEl = document.getElementById("postShare");

      const resultTable = document.getElementById("resultTable");

      /* inputs that trigger full update */
      const inputsToWatch = [
        incomeEl,
        needsEl,
        wantsEl,
        savingsPctEl,
        goodEl,
        currentAgeEl,
        retireAgeEl,
        deathAgeEl,
        currentSavingsEl,
        stepUpEl,
        retireExpensesEl,
        inflationEl,
        /* investment table inputs (all) */
        document.getElementById("preFixR"),
        document.getElementById("preFixT"),
        document.getElementById("preFixS"),
        document.getElementById("preLCapR"),
        document.getElementById("preLCapT"),
        document.getElementById("preLCapS"),
        document.getElementById("preMCapR"),
        document.getElementById("preMCapT"),
        document.getElementById("preMCapS"),
        document.getElementById("preSCapR"),
        document.getElementById("preSCapT"),
        document.getElementById("preSCapS"),
        document.getElementById("postFixR"),
        document.getElementById("postFixT"),
        document.getElementById("postFixS"),
        document.getElementById("postLCapR"),
        document.getElementById("postLCapT"),
        document.getElementById("postLCapS"),
        document.getElementById("postMCapR"),
        document.getElementById("postMCapT"),
        document.getElementById("postMCapS"),
        document.getElementById("postSCapR"),
        document.getElementById("postSCapT"),
        document.getElementById("postSCapS"),
      ];

      /* Auto-format income input to Indian grouping and update */
      function autoFormatIncome() {
        let val = incomeEl.value.replace(/[^0-9]/g, "");
        if (!val) return;
        incomeEl.value = Number(val).toLocaleString("en-IN");
      }

      /* Auto-format rupee inputs that should show commas */
      function autoFormatRupeeInputs() {
        const targets = ["currentSavings", "retireExpenses"];
        targets.forEach((id) => {
          const el = document.getElementById(id);
          const fmtFn = () => {
            let val = el.value.replace(/[^0-9]/g, "");
            if (!val) {
              el.value = "";
              return;
            }
            el.value = Number(val).toLocaleString("en-IN");
            // trigger update since these affect simulation
            updateAll();
          };
          el.addEventListener("input", fmtFn);
          el.addEventListener("blur", fmtFn);
        });
      }

      /* Validate ratios sum to 100% */
      function validateBudgetRatios() {
        const n = Number(needsEl.value) || 0;
        const w = Number(wantsEl.value) || 0;
        const s = Number(savingsPctEl.value) || 0;
        const g = Number(goodEl.value) || 0;
        const sum = n + w + s + g;
        if (Math.abs(sum - 100) > 0.001) {
          ratioError.textContent = `Budget ratios must sum to 100%. (Current: ${sum}%)`;
          ratioError.classList.remove("hidden");
          return { ok: false, sum };
        }
        ratioError.classList.add("hidden");
        return { ok: true, sum };
      }

      /* Update tax & budget outputs */
      function updateTaxAndBudget() {
        const income = parseIncome(incomeEl.value.trim());
        const taxRes = compute_tax(income);
        outTaxable.textContent = "₹" + formatIndian(taxRes.taxable);
        outTotal.textContent = "₹" + formatIndian(taxRes.total);
        outRate.textContent = taxRes.effective_rate.toFixed(2) + " %";
        outTakehome.textContent = "₹" + formatIndian(taxRes.takehome);

        const validation = validateBudgetRatios();
        if (!validation.ok) {
          needsAmtEl.textContent =
            wantsAmtEl.textContent =
            savingsAmtEl.textContent =
            goodAmtEl.textContent =
              "—";
          return { ok: false, taxRes };
        }

        const n = Number(needsEl.value) || 0;
        const w = Number(wantsEl.value) || 0;
        const s = Number(savingsPctEl.value) || 0;
        const g = Number(goodEl.value) || 0;
        const monthly = taxRes.takehome;

        needsAmtEl.textContent = fmt((monthly * n) / 100);
        wantsAmtEl.textContent = fmt((monthly * w) / 100);
        savingsAmtEl.textContent = fmt((monthly * s) / 100);
        goodAmtEl.textContent = fmt((monthly * g) / 100);

        return { ok: true, taxRes, savingsMonthly: (monthly * s) / 100 };
      }

      /* Update weighted summaries for investment tables */
      function updateWeightedSummaries() {
        const pre = computeWeighted("pre");
        const post = computeWeighted("post");

        preGrossEl.textContent = pre.gross.toFixed(1) + "%"; // composite pre-tax return
        preAfterEl.textContent = pre.tax.toFixed(1) + "%"; // weighted avg tax (display)
        preShareEl.textContent = pre.totalShare.toFixed(0) + "%"; // sum of shares

        postGrossEl.textContent = post.gross.toFixed(1) + "%";
        postAfterEl.textContent = post.tax.toFixed(1) + "%"; // weighted avg tax only (as requested)
        postShareEl.textContent = post.totalShare.toFixed(0) + "%";

        return { pre, post };
      }

      /* Main simulation (Excel-like formulas) */
      function runSimulation(savingsMonthlyFromBudget) {
        const prePost = updateWeightedSummaries();

        // require pre/post shares = 100 (we use user-entered scale 0..100)
        if (
          Math.abs(prePost.pre.totalShare - 100) > 0.001 ||
          Math.abs(prePost.post.totalShare - 100) > 0.001
        ) {
          resultTable.innerHTML = `<tr><td class="p-3 text-red-600" colspan="6">Error: Investment shares must total 100 for both tables.</td></tr>`;
          return;
        }

        const age = Number(currentAgeEl.value);
        const retireAge = Number(retireAgeEl.value);
        const deathAge = Number(deathAgeEl.value);
        // parse rupee fields by stripping commas
        let savings =
          Number(String(currentSavingsEl.value).replace(/,/g, "")) || 0;
        let monthlyInvest = Number(savingsMonthlyFromBudget) || 0; // taken from budget
        const stepUp = (Number(stepUpEl.value) || 0) / 100;
        const inflation = (Number(inflationEl.value) || 0) / 100;
        const baseExpense =
          Number(String(retireExpensesEl.value).replace(/,/g, "")) || 0;

        // table reset
        resultTable.innerHTML = "";
        let prevPlannedExpense = 0;

        for (let yr = age; yr <= deathAge; yr++) {
          const startSav = savings;
          let status = yr < retireAge ? "Earning" : "Retired";
          if (yr > deathAge) status = "Dead";

          // Planned expense logic (post-retirement expenses grow with inflation)
          let plannedExpense = 0;
          if (status === "Retired") {
            if (yr === retireAge) {
              plannedExpense =
                baseExpense * Math.pow(1 + inflation, retireAge - age) * 12;
            } else {
              plannedExpense = prevPlannedExpense * (1 + inflation);
            }
          }

          // Additional Savings = monthlyInvest * 12 only when earning
          let addSaving = status === "Earning" ? monthlyInvest * 12 : 0;

          // Ending savings formula (Excel IF equivalent)
          let endSav = 0;
          if (status === "Earning") {
            // startSav * (1 + preGross%) - plannedExpense/(1-inflation) + addSaving
            endSav =
              startSav * (1 + prePost.pre.gross / 100) -
              plannedExpense / (1 - inflation) +
              addSaving;
          } else if (status === "Retired") {
            // startSav * (1 + postGross%) - plannedExpense + addSaving
            endSav =
              startSav * (1 + prePost.post.gross / 100) -
              plannedExpense +
              addSaving;
          } else {
            endSav = 0;
          }

          // Inflation-adjusted equivalent value (today's ₹) by discounting back to current age
          const realValue = endSav / Math.pow(1 + inflation, yr - age);

          // Milestone highlighting: ₹1 Cr, ₹10 Cr, ₹100 Cr
          let milestoneClass = "";
          if (endSav >= 1000000000)
            milestoneClass = "bg-purple-200 font-bold"; // ₹100 Cr
          else if (endSav >= 100000000)
            milestoneClass = "bg-pink-100 font-semibold"; // ₹10 Cr
          else if (endSav >= 10000000)
            milestoneClass = "bg-yellow-100 font-semibold"; // ₹1 Cr

          // render row (show today's equivalent in brackets)
          const tr = document.createElement("tr");
          tr.innerHTML = `
      <td class="p-2 border">${yr}</td>
      <td class="p-2 border">${fmt(startSav)}</td>
      <td class="p-2 border">${fmt(plannedExpense)}</td>
      <td class="p-2 border">${fmt(addSaving)}</td>
      <td class="p-2 border ${milestoneClass} ${
            endSav < 0 ? "text-red-600 font-semibold" : ""
          }">
        ${fmt(endSav)}
        <div class="text-xs text-slate-500 mt-1">(≈ ${fmt(
          realValue
        )} today)</div>
      </td>
      <td class="p-2 border">${status}</td>
    `;
          resultTable.appendChild(tr);

          // prepare next year
          savings = endSav;
          prevPlannedExpense = plannedExpense;
          monthlyInvest *= 1 + stepUp;
        }
      }

      /* Full update: tax, budget, summaries, simulation */
      function updateAll() {
        autoFormatIncome(); // formats income display (commas)
        const taxBudget = updateTaxAndBudget();
        updateWeightedSummaries();
        if (taxBudget.ok) {
          runSimulation(taxBudget.savingsMonthly);
        } else {
          resultTable.innerHTML = `<tr><td class="p-3 text-slate-500" colspan="6">Fix budget ratios to 100% to run simulation.</td></tr>`;
        }
      }

      /* Wire inputs to auto update */
      inputsToWatch.forEach((el) => {
        if (el) el.addEventListener("input", updateAll);
      });

      /* Init defaults */
      window.addEventListener("load", () => {
        autoFormatRupeeInputs();
        incomeEl.value = DEFAULT_INCOME.toLocaleString("en-IN");
        // format retireExpenses initial value
        retireExpensesEl.value = String(
          Number(retireExpensesEl.value || 0)
        ).replace(/(\d)(?=(\d{2})+\d{3}\b)/g, "$1,");
        currentSavingsEl.value = String(currentSavingsEl.value || "0");
        updateAll();
      });
    </script>
  </body>
</html>
